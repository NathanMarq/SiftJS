var SIFT=function(a){return a.version="0.0.1",a}(SIFT||{});SIFT.sourceImages={},SIFT.destinations={},SIFT.tempCanvas=document.createElement("canvas"),SIFT.tempCTX=SIFT.tempCanvas.getContext("2d"),SIFT.newSourceImage=function(a,b){if(!SIFT.sourceImages[a]){var c=new Image;c.onload=function(){SIFT.sourceImages[a]=c,b(c)},c.src=a}},SIFT.imageCache={saveFromData:function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=a.width,c.height=a.height,d.putImageData(a,0,0);var e=c.toDataURL("image/png"),f=new Image;return f.onload=function(){SIFT.imageCache.saved[b]=f},f.src=e,c=null,this.saved[b]},saveFromImage:function(){},get:function(a){return this.saved[a]},saved:{}},SIFT.baseAlgorithms={convolveHorizontal:function(a,b,c){for(var d=b.length,e=Math.floor(d/2),f=a.data,g=a.width,h=a.height,i=g,j=h,k=SIFT.tempCTX.createImageData(i,j),l=k.data,m=c?1:0,n=0;j>n;n++)for(var o=0;i>o;o++){for(var p=n,q=o,r=4*(n*i+o),s=0,t=0,u=0,v=0,w=0;d>w;w++){var x=p,y=Math.min(g-1,Math.max(0,q+w-e)),z=4*(x*g+y),A=b[w];s+=f[z]*A,t+=f[z+1]*A,u+=f[z+2]*A,v+=f[z+3]*A}l[r]=s,l[r+1]=t,l[r+2]=u,l[r+3]=v+m*(255-v)}return k},convolveVertical:function(a,b,c){for(var d=b.length,e=Math.floor(d/2),f=a.data,g=a.width,h=a.height,i=g,j=h,k=SIFT.tempCTX.createImageData(i,j),l=k.data,m=c?1:0,n=0;j>n;n++)for(var o=0;i>o;o++){for(var p=n,q=o,r=4*(n*i+o),s=0,t=0,u=0,v=0,w=0;d>w;w++){var x=Math.min(h-1,Math.max(0,p+w-e)),y=q,z=4*(x*g+y),A=b[w];s+=f[z]*A,t+=f[z+1]*A,u+=f[z+2]*A,v+=f[z+3]*A}l[r]=s,l[r+1]=t,l[r+2]=u,l[r+3]=v+m*(255-v)}return k},convolveKernel:function(a,b,c){c=c||!1;for(var d=Math.round(Math.sqrt(b.length)),e=Math.floor(d/2),f=a.data,g=a.width,h=a.height,i=g,j=h,k=SIFT.tempCTX.createImageData(i,j),l=k.data,m=c?1:0,n=0;j>n;n++)for(var o=0;i>o;o++){for(var p=n,q=o,r=4*(n*i+o),s=0,t=0,u=0,v=0,w=0;d>w;w++)for(var x=0;d>x;x++){var y=p+w-e,z=q+x-e;y=y>h||0>y?Math.abs(y%h):y,z=z>g||0>z?Math.abs(z%g):z;var A=4*(y*g+z),B=b[w*d+x];s+=f[A]*B,t+=f[A+1]*B,u+=f[A+2]*B,v+=f[A+3]*B}l[r]=s,l[r+1]=t,l[r+2]=u,l[r+3]=v+m*(255-v)}return k},convolveKernelFloat32:function(a,b,c){c=c||!1;for(var d=Math.round(Math.sqrt(b.length)),e=Math.floor(d/2),f=a.data,g=a.width,h=a.height,i=g,j=h,k={width:i,height:j,data:new Float32Array(i*j*4)},l=k.data,m=c?1:0,n=0;j>n;n++)for(var o=0;i>o;o++){for(var p=n,q=o,r=4*(n*i+o),s=0,t=0,u=0,v=0,w=0;d>w;w++)for(var x=0;d>x;x++){var y=p+w-e,z=q+x-e;y=y>h||0>y?Math.abs(y%h):y,z=z>g||0>z?Math.abs(z%g):z;var A=4*(y*g+z),B=b[w*d+x];s+=f[A]*B,t+=f[A+1]*B,u+=f[A+2]*B,v+=f[A+3]*B}l[r]=s,l[r+1]=t,l[r+2]=u,l[r+3]=v+m*(255-v)}return k},rgbToHsv:function(a,b,c){a/=255,b/=255,c/=255;var d,e,f=Math.max(a,b,c),g=Math.min(a,b,c),h=f,i=f-g;if(e=0==f?0:i/f,f==g)d=0;else{switch(f){case a:d=(b-c)/i+(c>b?6:0);break;case b:d=(c-a)/i+2;break;case c:d=(a-b)/i+4}d/=6}return[d,e,h]},hsvToRgb:function(a,b,c){var d,e,f,g=Math.floor(6*a),h=6*a-g,i=c*(1-b),j=c*(1-h*b),k=c*(1-(1-h)*b);switch(g%6){case 0:d=c,e=k,f=i;break;case 1:d=j,e=c,f=i;break;case 2:d=i,e=c,f=k;break;case 3:d=i,e=j,f=c;break;case 4:d=k,e=i,f=c;break;case 5:d=c,e=i,f=j}return[255*d,255*e,255*f]}},SIFT.Kernel={sobel:{threeByThree:{horizontal:[-1,-2,-1,0,0,0,1,2,1],vertical:[-1,0,1,-2,0,2,-1,0,1],maxVal:510},fiveByFive:{horizontal:[-1,-4,-6,-4,-1,-2,-8,-12,-8,-2,0,0,0,0,0,2,8,12,8,2,1,4,6,4,1],vertical:[1,2,0,-2,-1,4,8,0,-8,-4,6,12,0,-12,-6,4,8,0,-8,-4,1,2,0,-2,-1],maxVal:1020}},kirsch:{north:[5,5,5,-3,0,-3,-3,-3,-3],northEast:[-3,5,5,-3,0,5,-3,-3,-3],east:[-3,-3,5,-3,0,5,-3,-3,5],southEast:[-3,-3,-3,-3,0,5,-3,5,5],south:[-3,-3,-3,-3,0,-3,5,5,5],southWest:[-3,-3,-3,5,0,-3,5,5,-3],west:[5,-3,-3,5,0,-3,5,-3,-3],northWest:[5,5,-3,5,0,-3,-3,-3,-3]},laplacianOfGaussian:{nineByNine:[0,1,1,2,2,2,1,1,0,1,2,4,5,5,5,4,2,1,1,4,5,3,0,3,5,4,1,2,5,3,-12,-24,-12,3,5,2,2,5,0,-24,-40,-24,0,5,2,2,5,3,-12,-24,-12,3,5,2,1,4,5,3,0,3,5,4,1,1,2,4,5,5,5,4,2,1,0,1,1,2,2,2,1,1,0]},prewitt:{threeByThree:{horizontal:[-1,-1,-1,0,0,0,1,1,1],vertical:[-1,0,1,-1,0,1,-1,0,1]},fiveByFive:{horizontal:[-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,0,0,0,0,0,2,2,2,2,2,1,1,1,1,1],vertical:[-1,-2,0,2,1,-1,-2,0,2,1,-1,-2,0,2,1,-1,-2,0,2,1,-1,-2,0,2,1]}},blur:{threeByThree:[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],fiveByFive:[.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04,.04]},motionBlur:{threeByThree:[1,0,0,0,1,0,0,0,1],fiveByFive:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]},gaussianBlur:{threeByThree:[1/16,1/8,1/16,1/8,.25,1/8,1/16,1/8,1/16],fiveByFive:[1/64,1/32,1/16,1/32,1/64,1/32,1/16,1/8,1/16,1/32,1/16,1/8,.25,1/8,1/16,1/32,1/16,1/8,1/16,1/32,1/64,1/32,1/16,1/32,1/64]},sharpen:{threeByThree:[0,-1,0,-1,5,-1,0,-1,0]}},SIFT.Filter={blackAndWhite:function(a,b){for(var c=(b.level||1,a.data),d=0;d<c.length;d+=4){var e=c[d],f=c[d+1],g=c[d+2],h=.2126*e+.7152*f+.0722*g;h=h,c[d]=c[d+1]=c[d+2]=h}return a},saturation:function(a,b){for(var c=(b.level||1,0);c<data.length;c+=4){var d=data[c],e=data[c+1],f=data[c+2],g=.2126*d+.7152*e+.0722*f;data[c]=data[c+1]=data[c+2]=g}return a},brighten:function(a,b){for(var c=b.brightness||50,d=a.data,e=0;e<d.length;e+=4)d[e]+=c,d[e+1]+=c,d[e+2]+=c;return a},contrast:function(a,b){for(var c=b.contrast||0,d=a.data,e=259*(c+255)/(255*(259-c)),f=0;f<d.length;f+=4)d[f]=e*(d[f]-128)+128,d[f+1]=e*(d[f+1]-128)+128,d[f+2]=e*(d[f+2]-128)+128;return a},invert:function(a){for(var b=a.data,c=0;c<b.length;c+=4)b[c]=255-b[c],b[c+1]=255-b[c+1],b[c+2]=255-b[c+2];return a},gamma:function(a,b){for(var c=b.gamma||.5,d=a.data,e=0;e<d.length;e+=4)d[e]=Math.pow(255*(d[e]/255),c),d[e+1]=Math.pow(255*(d[e+1]/255),c),d[e+2]=Math.pow(255*(d[e+2]/255),c);return a},threshold:function(a,b){for(var c=(b.value||100,a.data),d=0;d<c.length;d+=4){var e=c[d],f=c[d+1],g=c[d+2],h=.2126*e+.7152*f+.0722*g>=threshold?255:0;c[d]=c[d+1]=c[d+2]=h}return a},otsuThreshold:function(a,b){for(var c=0,d=1;256>d;++d)c+=d*a[d];for(var e,f,g=0,h=0,i=0,j=0,k=0,l=0,m=0,d=0;256>d;++d)if(h+=a[d],0!=h){if(i=b-h,0==i)break;g+=d*a[d],e=g/h,f=(c-g)/i,k=h*i*Math.pow(e-f,2),k>=j&&(l=d,k>j&&(m=d),j=k)}return(l+m)/2},detectShadows:function(a,b){for(var c=b.amount||1,d=0,e=0,f=0,g=0,h=a.data,i=[],j=0;j<h.length;j+=4){var k=a.data[j],l=a.data[j+1],m=a.data[j+2],n=SIFT.baseAlgorithms.rgbToHsv(k,l,m);d=n[1]>d?n[1]:d,e=n[1]<e?n[1]:e,f=n[2]>f?n[2]:f,g=n[2]<g?n[2]:g,i[j]=n[1],i[j+1]=n[2]}for(var o=Math.round(d-c),p=Math.round(f-c),q=0;q<h.length;q+=4)i[q]<=o&&i[q+1]<=p?(h[q]=Math.round(255*i[q]*(c+2)),h[q+1]=Math.round(255*i[q]*(c+2)),h[q+2]=Math.round(255*i[q]*(c+2))):(h[q]=0,h[q+1]=0,h[q+2]=0);return a},sharpen:function(){},gaussianBlur:function(a,b,c){var c=c||1,d=Math.abs(b.diameter)||1;if(1>d)return SIFT.baseAlgorithms.convolveKernel(a,SIFT.Kernel.gaussianBlur.threeByThree);for(var e=d/2,f=Math.ceil(d)+(1-Math.ceil(d)%2),g=new Float32Array(f),h=(e+.5)/3,i=h*h,j=1/Math.sqrt(2*Math.PI*i),k=-1/(2*h*h),l=0,m=Math.floor(f/2),n=0;f>n;n++){var o=n-m,p=j*Math.exp(o*o*k);g[n]=p,l+=p}for(var n=0;n<g.length;n++)g[n]/=l;var q=SIFT.baseAlgorithms.convolveHorizontal(SIFT.baseAlgorithms.convolveVertical(a,g,c),g,c);return q},median:function(a,b,c){for(var d=Math.abs(b.diameter)||1,e=(Math.ceil(d)+(1-Math.ceil(d)%2),d*d),f=Math.round(e/2),g=Math.round(Math.sqrt(e)),h=Math.floor(g/2),i=a.data,j=a.width,k=a.height,l=j,m=k,n=SIFT.tempCTX.createImageData(l,m),o=n.data,p=0;m>p;p++)for(var q=0;l>q;q++){for(var r=p,s=q,t=4*(p*l+q),u=[],v=[],w=[],x=[],y=0;g>y;y++)for(var z=0;g>z;z++){var A=r+y-h,B=s+z-h;A=A>k||0>A?Math.abs(A%k):A,B=B>j||0>B?Math.abs(B%j):B;var C=4*(A*j+B);u.push(i[C]),v.push(i[C+1]),w.push(i[C+2]),x.push(i[C+3])}u=u.sort(function(a,b){return a-b}),v=v.sort(function(a,b){return a-b}),w=w.sort(function(a,b){return a-b}),x=x.sort(function(a,b){return a-b}),o[t]=u[f],o[t+1]=v[f],o[t+2]=w[f],o[t+3]=x[f]}return n},sobel:function(a,b){for(var c=(b.strength||1,b.invert||!1,SIFT.Filter.blackAndWhite(a,1)),d=SIFT.baseAlgorithms.convolveKernelFloat32(c,SIFT.Kernel.sobel.threeByThree.vertical),e=SIFT.baseAlgorithms.convolveKernelFloat32(c,SIFT.Kernel.sobel.threeByThree.horizontal),f=SIFT.tempCTX.createImageData(d.width,d.height),g=0;g<f.data.length;g+=4){var h=Math.abs(d.data[g]),i=Math.abs(e.data[g]),j=h+i;f.data[g]=j,f.data[g+1]=j,f.data[g+2]=j,f.data[g+3]=255}return f},depthChannels:function(a,b){for(var c=b.smallStrength||.5,d=b.mediumStrength||.5,e=b.largeStrength||.5,f=b.invertX?1:-1,g=b.invertY?1:-1,h=b.count||3,i=c*f,j=c*g,k=SIFT.Filter.blackAndWhite(a,{level:1}),l=SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.north),m=SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.northEast),n=(SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.east),SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.southEast)),o=(SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.south),SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.southWest)),p=SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.west),q=SIFT.baseAlgorithms.convolveKernelFloat32(k,SIFT.Kernel.kirsch.northWest),r=SIFT.tempCTX.createImageData(k.width,k.height),s=0;s<r.data.length;s+=4){var t=p.data[s]+(q.data[s]+o.data[s])/2-(m.data[s]+n.data[s])/2,u=.125*(t*j+1020);r.data[s]=u;var v=l.data[s]+(m.data[s]+q.data[s])/2-(n.data[s]+o.data[s])/2,w=.125*(v*i+1020);r.data[s+1]=w,r.data[s+2]=255,r.data[s+3]=a.data[s+3]}for(var x=SIFT.Filter.gaussianBlur(r,{diameter:Math.ceil(a.width/25)},0),y=SIFT.Filter.gaussianBlur(r,{diameter:Math.ceil(a.width/40)},0),z=0;z<r.data.length;z+=4)r.data[z]=(r.data[z]+y.data[z]*e+x.data[z]*d)/h,r.data[z+1]=(r.data[z+1]+y.data[z]*e+x.data[z+1]*d)/h,r.data[z+2]=(r.data[z+2]+y.data[z]*e+x.data[z+2]*d)/h;return r},depthEdges:function(a){for(var b=SIFT.Filter.blackAndWhite(a,{level:1}),c=SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.north),d=SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.northEast),e=(SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.east),SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.southEast)),f=(SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.south),SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.southWest)),g=SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.west),h=SIFT.baseAlgorithms.convolveKernelFloat32(b,SIFT.Kernel.kirsch.northWest),i=SIFT.tempCTX.createImageData(b.width,b.height),j=0;j<i.data.length;j+=4){var k=g.data[j]+(h.data[j]+f.data[j])/2-(d.data[j]+e.data[j])/2,l=.125*(k+1020);i.data[j]=l;var m=c.data[j]+(d.data[j]+h.data[j])/2-(e.data[j]+f.data[j])/2,n=.125*(m+1020);i.data[j+1]=n,i.data[j+2]=255,i.data[j+3]=a.data[j+3]}return i},depthIntensity:function(c,d){for(var e=d.intensity||.5,f=128,h=128,i=0;i<c.data.length;i+=4)r=c.data[i],g=c.data[i+1],b=c.data[i+2],a=c.data[i+3],c.data[i]=f+(r-f)*e,c.data[i+1]=h+(g-h)*e,c.data[i+2]=c.data[i+2],c.data[i+3]=c.data[i+3];return c}},SIFT.Blender={combine:function(a){for(var b=a.length,c=SIFT.tempCTX.createImageData(a[0].width,a[0].height),d=1;b>d;d++)for(var e=a[d],f=0;f<e.data.length;f+=4)c.data[f]+=1*e.data[f]/b,c.data[f+1]+=1*e.data[f+1]/b,c.data[f+2]+=1*e.data[f+2]/b,c.data[f+3]+=1*e.data[f+3]/b;return c}};